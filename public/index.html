<script>
  // Matrix Background
  const canvas = document.getElementById("matrix");
  const ctx = canvas.getContext("2d");
  const fontSize = 12;
  const letters = 'アァイィウエオカキクケコサシスセソタチツテトナニヌネノ0123456789'.split('');
  let columns, drops;

  function initMatrix() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    columns = Math.floor(window.innerWidth / fontSize);
    drops = Array(columns).fill(1);
  }

  function drawMatrix() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#ff69b4';
    ctx.font = fontSize + 'px monospace';

    for (let i = 0; i < drops.length; i++) {
      const text = letters[Math.floor(Math.random() * letters.length)];
      ctx.fillText(text, i * fontSize, drops[i] * fontSize);
      if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }

    setTimeout(() => requestAnimationFrame(drawMatrix), 40);
  }

  initMatrix();
  drawMatrix();
  window.addEventListener("resize", initMatrix);

  // Timer Logic
  const input = document.getElementById('timeInput');
  const progressCircle = document.querySelector('.circle-progress');
  const beep = document.getElementById('beep');
  const overlay = document.getElementById('overlay');
  const RADIUS = 90;
  const CIRCUMFERENCE = 2 * Math.PI * RADIUS;
  let totalSeconds = 0, startTime = 0, running = false, rafId = null;
  let lastSetSeconds = 0;

  function timeToSeconds(timeStr) {
    const parts = timeStr.split(':').map(p => parseInt(p, 10));
    if (parts.length !== 3 || parts.some(p => isNaN(p))) return null;
    const [h, m, s] = parts;
    if (h < 0 || m < 0 || s < 0 || m >= 60 || s >= 60) return null;
    return h * 3600 + m * 60 + s;
  }

  function secondsToTime(sec) {
    const h = String(Math.floor(sec / 3600)).padStart(2, '0');
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  function updateProgress(ratio) {
    const offset = CIRCUMFERENCE * (1 - ratio);
    progressCircle.style.strokeDashoffset = offset;
  }

  function validateInput() {
    const secs = timeToSeconds(input.value);
    if (secs === null || secs <= 0) {
      input.classList.add('invalid');
      return false;
    } else {
      input.classList.remove('invalid');
      return true;
    }
  }

  function animateCountdown(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = (timestamp - startTime) / 1000;
    const remaining = Math.max(0, totalSeconds - elapsed);
    input.value = secondsToTime(Math.ceil(remaining));
    updateProgress(remaining / totalSeconds);

    if (remaining > 0) {
      rafId = requestAnimationFrame(animateCountdown);
    } else {
      running = false;
      beep.play();
      overlay.style.opacity = '0.8';
      setTimeout(() => overlay.style.opacity = '0', 400);
    }
  }

  function startTimer() {
    if (running || !validateInput()) return;
    totalSeconds = timeToSeconds(input.value);
    lastSetSeconds = totalSeconds; // Remember last valid set time
    startTime = null;
    running = true;
    updateProgress(1);
    rafId = requestAnimationFrame(animateCountdown);
  }

  function pauseTimer() {
    if (rafId) cancelAnimationFrame(rafId);
    running = false;
  }

  function resetTimer() {
    if (rafId) cancelAnimationFrame(rafId);
    running = false;
    input.value = secondsToTime(lastSetSeconds);
    updateProgress(1);
  }

  function setQuickTime(seconds) {
    lastSetSeconds = seconds;
    totalSeconds = seconds;
    input.value = secondsToTime(seconds);
    updateProgress(1);
    startTimer();
  }

  document.getElementById('startBtn').addEventListener('click', startTimer);
  document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
  document.getElementById('resetBtn').addEventListener('click', resetTimer);

  input.addEventListener('input', () => {
    if (validateInput()) {
      const val = timeToSeconds(input.value);
      if (!running && val !== null) {
        totalSeconds = val;
        lastSetSeconds = val;
        updateProgress(1);
      }
    }
  });

  progressCircle.style.strokeDasharray = CIRCUMFERENCE;
  progressCircle.style.strokeDashoffset = 0;
</script>
